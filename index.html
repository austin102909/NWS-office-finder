<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="description" content="Find your local NWS office for storm chasing with social media tags." />
    <title>NWS Office Finder</title>

    <!-- PWA Essentials -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icon.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icon.png" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex flex-col items-center justify-center text-white p-4">
    <main class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl shadow-xl p-6 max-w-md w-full animate-fadeIn">
        <h1 class="text-3xl font-bold text-center mb-4">NWS Office Finder</h1>
        <p class="text-center mb-6 text-lg">Find your local NWS office for storm chasing!</p>
        <button 
            onclick="getLocation()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-300">
            Find My NWS Office
        </button>
        <div id="output" class="mt-6 text-center"></div>
        <div id="error" class="mt-4 text-red-300 text-center"></div>
        <div id="time" class="mt-6 text-center text-sm"></div>
    </main>

    <script>
        // Update local and UTC time every second
        function updateTime() {
            const now = new Date();
            const localTime = now.toLocaleString('en-US', { timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone, hour12: true });
            const utcTime = now.toLocaleString('en-US', { timeZone: 'UTC', hour12: false }) + ' Zulu';
            document.getElementById('time').innerHTML = `Local Time: ${localTime}<br>UTC Time: ${utcTime}`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        function getLocation() {
            const output = document.getElementById('output');
            const error = document.getElementById('error');
            output.innerHTML = '<p class="text-yellow-200">Fetching your location...</p>';
            error.innerHTML = '';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => fetchNWSOffice(position.coords.latitude, position.coords.longitude),
                    err => {
                        error.innerHTML = `Error getting location: ${err.message}`;
                        output.innerHTML = '';
                    }
                );
            } else {
                error.innerHTML = 'Geolocation is not supported by this browser.';
                output.innerHTML = '';
            }
        }

        async function fetchNWSOffice(lat, lon) {
            const output = document.getElementById('output');
            const error = document.getElementById('error');
            const url = `https://api.weather.gov/points/${lat.toFixed(4)},${lon.toFixed(4)}`;

            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'NWS Office Finder (n.texas.weather@gmail.com)' }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const data = await response.json();
                const wfoId = data.properties.cwa;
                const wfoInfo = getWfoInfo(wfoId);

                output.innerHTML = `
                    <p class="text-xl font-semibold">Your NWS Office: <strong>${wfoId}</strong> (${wfoInfo.name})</p>
                    <p>Use <strong>@${wfoInfo.socialHandle}</strong> for tagging on X and Facebook.</p>
                `;
            } catch (err) {
                error.innerHTML = `Error fetching NWS office: ${err.message}`;
                output.innerHTML = '';
            }
        }

        // WFO codes mapping
        function getWfoInfo(wfoId) {
            const wfoData = { /* ... full mapping stays unchanged ... */ };
            return wfoData[wfoId] || { name: 'Unknown Office', socialHandle: 'NWS' };
        }

        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
